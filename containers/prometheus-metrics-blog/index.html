<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.99.1"><meta name=robots content="index, follow"><link rel="shortcut icon" href=../../favicons/favicon.ico><link rel=apple-touch-icon href=../../favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=../../favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=../../favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=../../favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=../../favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=../../favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=../../favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=../../favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=../../favicons/android-192x192.png sizes=192x192><title>Scraping metrics with Prometheus |</title><meta name=description content="To scrape metrics from Vertica, you currently need to setup a SQL exporter. This exporter issues queries against Vertica, taking data from various DC tables and virtual tables. This can be costly as it needs to go through the query plan optimizer. For complicated queries, this might result in joins from different tables. In version 23.3.0, Vertica introduced in-database metrics. Vertica is already very rich in metrics with the various system and DC tables that it offers, but now you can get them cheaply with Prometheus in-database metrics."><meta property="og:title" content="Scraping metrics with Prometheus"><meta property="og:description" content="To scrape metrics from Vertica, you currently need to setup a SQL exporter. This exporter issues queries against Vertica, taking data from various DC tables and virtual tables. This can be costly as it needs to go through the query plan optimizer. For complicated queries, this might result in joins from different tables. In version 23.3.0, Vertica introduced in-database metrics. Vertica is already very rich in metrics with the various system and DC tables that it offers, but now you can get them cheaply with Prometheus in-database metrics."><meta property="og:type" content="article"><meta property="og:url" content="/containers/prometheus-metrics-blog/"><meta property="article:section" content="containers"><meta itemprop=name content="Scraping metrics with Prometheus"><meta itemprop=description content="To scrape metrics from Vertica, you currently need to setup a SQL exporter. This exporter issues queries against Vertica, taking data from various DC tables and virtual tables. This can be costly as it needs to go through the query plan optimizer. For complicated queries, this might result in joins from different tables. In version 23.3.0, Vertica introduced in-database metrics. Vertica is already very rich in metrics with the various system and DC tables that it offers, but now you can get them cheaply with Prometheus in-database metrics."><meta itemprop=wordCount content="1491"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Scraping metrics with Prometheus"><meta name=twitter:description content="To scrape metrics from Vertica, you currently need to setup a SQL exporter. This exporter issues queries against Vertica, taking data from various DC tables and virtual tables. This can be costly as it needs to go through the query plan optimizer. For complicated queries, this might result in joins from different tables. In version 23.3.0, Vertica introduced in-database metrics. Vertica is already very rich in metrics with the various system and DC tables that it offers, but now you can get them cheaply with Prometheus in-database metrics."><link rel=preload href=../../scss/main.min.8a6ed667b3d1bd12fba7ff44e1fe8c839f35d62b1dd330530f402a195a4dac52.css as=style><link href=../../scss/main.min.8a6ed667b3d1bd12fba7ff44e1fe8c839f35d62b1dd330530f402a195a4dac52.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script>
<link rel=stylesheet href=../../css/prism.css></head><body class=td-page><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=../../><span class="navbar-brand__logo navbar-logo"><svg width="398" height="142" viewBox="0 0 398 142" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" preserveAspectRatio="xMinYMin"><title>Vertica-OT-White</title><g id="Outlined" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="Logos---Outlined-(Dark-Bg)" transform="translate(-970.000000, -645.000000)" fill="#fff" fill-rule="nonzero"><path d="M979.5728 750.5824H982.9136V760.912C983.7328 759.8368 984.68 759.0048 985.7552 758.416 986.8304 757.8272 988.0976 757.5328 989.5568 757.5328 990.9648 757.5328 992.2 757.7888 993.2624 758.3008 994.3248 758.8128 995.208 759.5296 995.912 760.4512 996.616 761.3728 997.1408 762.4672 997.4864 763.7344S998.0048 766.4032 998.0048 767.9392C998.0048 769.5776 997.8 771.056 997.3904 772.3744S996.392 774.8128 995.624 775.7344C994.856 776.656 993.928 777.3664 992.84 777.8656 991.752 778.3648 990.5296 778.6144 989.1728 778.6144 988.0208 778.6144 986.9008 778.3776 985.8128 777.904 984.7248 777.4304 983.7456 776.6176 982.8752 775.4656V778H979.5728V750.5824zM982.8752 768.6304C982.8752 769.9104 983.0224 771.0048 983.3168 771.9136 983.6112 772.8224 984.0144 773.5712 984.5264 774.16 985.0384 774.7488 985.6528 775.1776 986.3696 775.4464 987.0864 775.7152 987.8672 775.8496 988.712 775.8496 989.5312 775.8496 990.2928 775.7088 990.9968 775.4272S992.3088 774.6912 992.8208 774.064C993.3328 773.4368 993.736 772.624 994.0304 771.6256 994.3248 770.6272 994.472 769.4112 994.472 767.9776 994.472 766.5184 994.312 765.296 993.992 764.3104 993.672 763.3248 993.256 762.5376 992.744 761.9488 992.232 761.36 991.6496 760.9376 990.9968 760.6816S989.672 760.2976 988.9808 760.2976C988.1104 760.2976 987.304 760.4448 986.5616 760.7392S985.1728 761.4688 984.6224 762.0448C984.072 762.6208 983.6432 763.3504 983.336 764.2336S982.8752 766.1344 982.8752 767.2864V768.6304zm19.5456 13.5936C1003.1376 782.48 1003.8544 782.608 1004.5712 782.608 1005.3904 782.608 1006.024 782.3968 1006.472 781.9744 1006.92 781.552 1007.3616 780.7648 1007.7968 779.6128L1008.6032 777.5008 1000.1936 758.1472H1004.072L1010.3312 773.7376 1016.0528 758.1472H1019.7392L1011.0608 779.8816C1010.7024 780.7776 1010.344 781.5648 1009.9856 782.2432 1009.6272 782.9216 1009.2304 783.504 1008.7952 783.9904S1007.8416 784.8416 1007.24 785.0848 1005.9024 785.4496 1005.032 785.4496C1004.4176 785.4496 1003.8672 785.4112 1003.3808 785.3344 1002.8944 785.2576 1002.3568 785.1168 1001.768 784.912L1002.4208 782.224zm68.6254-26.884714c5.90264000000002.0 10.10727 4.33928500000002 10.10727 12.133928C1081.15347 772.294643 1079.37459 779.848214 1070.72277 779.848214 1067.65017 779.848214 1065.22442 778.160714 1064.65842 777.196429V787H1057.5429V755.901786H1064.73927V757.991071C1065.38614 756.946429 1067.56931 755.339286 1071.0462 755.339286zm-28.13861.0C1052.77228 755.901786 1054.95545 763.294643 1054.95545 767.553571 1054.95545 773.5 1051.39769 779.928571 1042.01815 779.928571 1035.22607 779.928571 1029 776.232143 1029 767.553571 1029 760.401786 1033.68977 754.857143 1042.90759 755.339286zM1104.60231 758.392857C1107.75578 761.6875 1107.91749 766.267857 1107.99835 768.919643H1090.61386C1090.61386 771.8125 1092.31188 774.785714 1096.19307 774.785714S1101.44884 772.294643 1102.33828 770.6875L1107.67492 773.258929C1107.02805 774.625 1104.92574 779.928571 1095.62706 779.928571c-7.19637000000012.0-12.20957-4.25892800000008-12.20957-11.973214.0-5.625 2.91088999999988-12.616071 12.4521499999998-12.616071C1097.32508 755.339286 1101.44884 755.178571 1104.60231 758.392857zM1170.17822 758.3125C1173.33168 761.607143 1173.4934 766.1875 1173.57426 768.839286H1156.27063C1156.18977 771.732143 1157.72607 774.705357 1161.5264 774.705357 1165.40759 774.705357 1166.5396 772.214286 1167.42904 770.607143L1172.84653 773.258929 1171.47195 775.267857C1170.17822 777.035714 1167.83333 779.848214 1160.9604 779.848214 1153.76403 779.848214 1148.9934 775.589286 1148.9934 767.875 1148.9934 762.25 1151.90429 755.258929 1161.44554 755.258929L1161.67122 755.258217C1163.29153 755.251276 1167.17492 755.251276 1170.17822 758.3125zM1206.88779 751V755.982143H1211.57756V760.803571H1206.88779V771.169643C1206.80693 772.616071 1206.80693 773.821429 1208.74752 773.821429L1211.25413 773.741071V779.125C1209.79868 779.366071 1208.82838 779.526786 1207.53465 779.526786 1205.02805 779.526786 1202.35974 779.366071 1200.82343 777.196429 1199.85314 775.830357 1199.77228 774.142857 1199.77228 771.892857V760.723214H1195.40594L1198.64026 755.901786H1199.77228V751H1206.88779zM1143.17162 751V755.901786H1150.5297L1147.29538 760.723214H1143.09076v10.446429C1143.0099 772.616071 1143.0099 773.821429 1144.9505 773.821429L1147.4571 773.741071V779.125C1145.92079 779.366071 1145.03135 779.526786 1143.73762 779.526786 1141.31188 779.526786 1138.56271 779.366071 1137.0264 777.196429 1136.05611 775.830357 1135.97525 774.142857 1135.97525 771.892857V751H1143.17162zM1125.14026 755.339286C1126.59571 755.339286 1128.21287 755.580357 1129.42574 756.223214 1131.93234 757.508929 1132.66007 759.598214 1132.66007 763.294643V779.366071H1125.4637V766.107143C1125.4637 764.017857 1125.38284 763.214286 1125.14026 762.571429 1124.57426 761.285714 1123.36139 760.803571 1121.90594 760.803571 1118.50302 760.803571 1118.21341 763.224981 1118.18876 765.914004L1118.18676 766.290737 1118.18647 779.366071H1111.07096V755.901786H1118.26733V757.991071C1118.99505 757.267857 1119.39934 756.705357 1120.69307 756.142857 1121.82508 755.660714 1123.36139 755.339286 1125.14026 755.339286zM1180.28548 755.982143 1184.08581 761.205357 1187.56271 755.982143H1195.64851L1188.29043 767.071429 1197.18482 779.366071H1189.01815L1184.32838 772.857143 1180.0429 779.366071H1171.9571L1180.20462 767.071429 1172.19967 755.982143H1180.28548zM1041.533 760.883929C1039.59241 760.964286 1038.37954 761.607143 1037.40924 763.053571 1036.5198 764.339286 1036.19637 765.946429 1036.19637 767.553571 1036.19637 771.169643 1038.05611 774.464286 1042.01815 774.464286 1045.89934 774.464286 1047.75908 771.410714 1047.75908 767.875 1047.75908 765.303571 1047.11221 763.375 1045.73762 762.169643 1044.28218 760.883929 1042.58416 760.803571 1041.533 760.883929zM1069.59076 760.723214C1068.29703 760.723214 1066.92244 761.205357 1065.95215 762.491071 1064.90099 763.696429 1064.4967 765.544643 1064.4967 767.633929 1064.4967 770.366071 1065.30528 772.053571 1066.19472 773.017857 1067.0033 773.901786 1068.21617 774.464286 1069.42904 774.464286 1072.90594 774.464286 1074.44224 770.928571 1074.44224 767.473214 1074.44224 764.580357 1073.55281 761.526786 1070.64191 760.883929 1070.23762 760.803571 1069.91419 760.723214 1069.59076 760.723214zM1095.70792 760C1094.0099 760 1092.79703 760.803571 1092.06931 761.526786 1091.09901 762.571429 1090.85644 763.616071 1090.61386 764.660714L1100.55941 764.580357C1100.39769 763.616071 1100.23597 762.25 1099.18482 761.285714 1098.29538 760.401786 1096.92079 760 1095.70792 760zM1161.36469 760C1159.66667 760 1158.4538 760.803571 1157.72607 761.526786 1156.75578 762.571429 1156.5132 763.616071 1156.27063 764.660714L1166.21617 764.580357C1166.05446 763.616071 1165.89274 762.25 1164.84158 761.285714 1163.95215 760.401786 1162.57756 760 1161.36469 760zM1221.28053 755.982143 1222.4934 759.839286 1223.70627 755.982143H1224.91914V760.803571H1224.11056V757.830357L1224.19142 756.866071 1223.94884 757.669643 1222.89769 760.883929H1222.08911L1221.03795 757.669643 1220.79538 756.866071 1220.87624 757.830357V760.803571H1220.06766V755.982143H1221.28053zM1219.66337 755.901786V756.625H1218.0462V760.803571H1217.23762V756.625H1215.62046V755.901786H1219.66337zM983.707685 647.665636 1012.49328 698.718315l28.88386-51.052679H1092.69771V659.626331h-44.32753L1012.58608 723 970 647.665636h13.707685zm108.992755 30.353198v11.960695H1053.70641v17.747247H1092.70044v11.960696H1041.74562V678.018834H1092.70044zM1218.81169 719.684742h11.95533V647.663998h-11.95533v72.020744zm-82.14076-72.016377C1148.0749 647.668365 1157.27341 656.8668 1157.27341 668.270676 1157.27341 676.824948 1151.93991 684.276499 1144.3955 687.31171L1162.05554 719.689109h-11.95533L1133.26448 688.780184h-23.6377V719.689109h-11.95533V647.668365zM1214.11799 647.666181V659.621418H1189.55771v60.065508h-11.95533V659.621418H1161.31802C1159.66393 654.932126 1156.8143 650.886998 1153.04209 647.851788V647.666181H1214.11799zm-77.44706 11.95742H1109.62678V676.917751H1136.67093C1141.45307 676.917751 1145.31808 673.05277 1145.31808 668.270676S1141.45307 659.623601 1136.67093 659.623601zm186.44473-14.624693L1292.3921 696.138932V696.231735C1288.06853 703.404877 1280.25116 708.19243 1271.33107 708.19243 1257.71618 708.19243 1246.67798 697.154308 1246.67798 683.539532c0-13.614775 11.0382-24.6528970000001 24.65309-24.6528970000001C1279.6998 658.886635 1287.0586 663.024566 1291.56778 669.4662L1298.00401 658.706487C1291.38217 651.527886 1281.90525 647.117005 1271.33107 647.117005 1251.18716 647.117005 1234.9028 663.395778 1234.9028 683.539532 1234.9028 703.683286 1251.18716 719.96206 1271.33107 719.96206 1284.57473 719.96206 1296.1643 712.881721 1302.60599 702.302156L1323.11566 668.08507 1354.20497 719.869257 1368 719.689109 1323.11566 644.998908z" id="Vertica-OT-White"/></g></g></svg></span><span class=navbar-brand__name></span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://www.vertica.com/docs/latest/HTML/Content/Home.htm target=_blank><span>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://www.vertica.com/knowledgebase/ target=_blank><span>Knowledge Base</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://academy.vertica.com/ target=_blank><span>Academy</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://forum.vertica.com/ target=_blank><span>Forum</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://www.microfocus.com/en-us/support/Vertica%20Analytics%20Platform target=_blank><span>Support</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="collapse td-sidebar-nav foldable-nav" id=td-section-nav><ul class="td-sidebar-nav__section pr-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m--li><a href=../../ class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-><span>Vertica Integrator's Guide</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-server-installation-li><input type=checkbox id=m-server-installation-check>
<label for=m-server-installation-check><a href=../../server-installation/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-server-installation><span>Server installation and configuration</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-containers-li><input type=checkbox id=m-containers-check checked>
<label for=m-containers-check><a href=../../containers/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-containers><span>Containerized Vertica</span></a></label><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-containerscreating-image-li><input type=checkbox id=m-containerscreating-image-check>
<label for=m-containerscreating-image-check><a href=../../containers/creating-image/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-containerscreating-image><span>Creating a Vertica image</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-containersk8s-dev-env-li><input type=checkbox id=m-containersk8s-dev-env-check>
<label for=m-containersk8s-dev-env-check><a href=../../containers/k8s-dev-env/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-containersk8s-dev-env><span>Vertica on Kubernetes development environment</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-containersprometheus-metrics-blog-li><input type=checkbox id=m-containersprometheus-metrics-blog-check checked>
<label for=m-containersprometheus-metrics-blog-check><a href=../../containers/prometheus-metrics-blog/ title="Scraping metrics with Prometheus" class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id=m-containersprometheus-metrics-blog><span class=td-sidebar-nav-active-item id=td-sidebar-nav-active-item>Scraping Prometheus metrics</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-containersvcluster-ops-li><input type=checkbox id=m-containersvcluster-ops-check>
<label for=m-containersvcluster-ops-check><a href=../../containers/vcluster-ops/ title="Client access with VClusterOps " class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-containersvcluster-ops><span>VClusterOps access</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-data-protocols-formats-li><input type=checkbox id=m-data-protocols-formats-check>
<label for=m-data-protocols-formats-check><a href=../../data-protocols-formats/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-data-protocols-formats><span>Data protocols and formats</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-cli-args-li><input type=checkbox id=m-cli-args-check>
<label for=m-cli-args-check><a href=../../cli-args/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-cli-args><span>Command line arguments</span></a></label></li></ul></li></ul></nav></div><script>var myElement=document.getElementById("td-sidebar-nav-active-item");myElement.scrollIntoView({behavior:"auto",block:"center",inline:"start"})</script></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"></div><div class=td-toc><nav id=TableOfContents><ul><li><ul><li><a href=#setting-up-prometheus-and-grafana>Setting up Prometheus and Grafana</a><ul><li><a href=#setting-up-k8s>Setting up K8s</a></li><li><a href=#installing-the-verticadb-operator>Installing the VerticaDB operator</a></li><li><a href=#deploying-a-three-node-cluster>Deploying a three-node cluster</a></li><li><a href=#install-prometheus-and-grafana>Install Prometheus and Grafana</a></li></ul></li><li><a href=#tear-down-k8s-cluster>Tear down K8s cluster</a></li></ul></li></ul></nav></div></aside><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><nav aria-label=breadcrumb class=td-breadcrumbs><ol class=breadcrumb><li class=breadcrumb-item><a href=../../containers/>Containerized Vertica</a></li><li class="breadcrumb-item active" aria-current=page><a href=../../containers/prometheus-metrics-blog/ aria-disabled=true class="btn-link disabled">Scraping Prometheus metrics</a></li></ol></nav><div class=td-content><h1>Scraping metrics with Prometheus</h1><header class=article-meta></header><p>To scrape metrics from Vertica, you currently need to setup a SQL exporter. This exporter issues queries against Vertica, taking data from various DC tables and virtual tables. This can be costly as it needs to go through the query plan optimizer. For complicated queries, this might result in joins from different tables. In version 23.3.0, Vertica introduced in-database metrics. Vertica is already very rich in metrics with the various system and DC tables that it offers, but now you can get them cheaply with Prometheus in-database metrics.</p><p>Vertica scrapes these metrics and outputs them in <a href=https://github.com/prometheus/docs/blob/main/content/docs/instrumenting/exposition_formats.md>Prometheus text-based exposition format</a>. This format applies context-specific labels to each metric so you can group metrics when you visualize your data. To export the metrics, we rely on the <a href=https://docs.vertica.com/latest/en/admin/managing-db/https-service/>HTTPS service</a> which exposes general-purpose endpoints for interacting with your database. Vertica exposes metrics through the /v1/metrics endpoint so you can scrape them with a GET request. For example:</p><pre tabindex=0><code>curl https://host:8443/v1/metrics \
    --key path/to/client_key.key \
    --cert path/to/client_cert.pem \
</code></pre><p>The following example outlines the output:</p><pre tabindex=0><code># HELP metric-name metric-definition
# TYPE metric-name metric-type
metric-name{label-key=&#34;label-value&#34;[, ...]} metric-value
</code></pre><p>For example, the following is a snippet of the request response that provides details about the vertica_resource_pool_memory_size_actual_kb metric:</p><pre tabindex=0><code>curl https://10.20.30.40:8443/v1/metrics \
    --key path/to/client_key.key \
    --cert path/to/client_cert.pem \
...
# HELP vertica_resource_pool_memory_size_actual_kb Current amount of memory (in kilobytes) allocated to the resource pool by the resource manager.
# TYPE vertica_resource_pool_memory_size_actual_kb gauge
vertica_resource_pool_memory_size_actual_kb{node_name=&#34;v_vmart_node0001&#34;,pool_name=&#34;metadata&#34;,revive_instance_id=&#34;114b25c4aab6fec8c26b121cff2b52&#34;} 84381
vertica_resource_pool_memory_size_actual_kb{node_name=&#34;v_vmart_node0001&#34;,pool_name=&#34;blobdata&#34;,revive_instance_id=&#34;114b25c4aab6fec8c26b121cff2b52&#34;} 0
vertica_resource_pool_memory_size_actual_kb{node_name=&#34;v_vmart_node0001&#34;,pool_name=&#34;jvm&#34;,revive_instance_id=&#34;114b25c4aab6fec8c26b121cff2b52&#34;} 0
...
</code></pre><p>For a comprehensive list of metrics, see <a href=https://docs.vertica.com/latest/en/admin/managing-db/https-service/prometheus-metrics/>Prometheus metrics</a>.</p><p>By exposing the metrics through an HTTP endpoint, we can not only make it easy for Vertica to be a Prometheus target but also visualize the Vertica metrics through a Grafana dashboard.</p><p><a href=https://prometheus.io/>Prometheus</a> is a monitoring and alerting system that is very popular with cloud native deployments. It collects time series events for different machines, called targets. In this case, the targets are Vertica nodes. To get metrics, Prometheus requires an exposed HTTP endpoint. If an endpoint is available, Prometheus can start scraping numerical data, capture it as a time series, and store it in a local database suited to time-series data. Prometheus is often combined with Grafana in order to visualize collected time-series data.</p><p>Grafana is an open-source solution that uses metrics to run analytics and provide insights into the complex infrastructure and massive amounts of data that services process. Grafana also provides customizable dashboards to visualize these analytics. It connects with every possible data source such as Graphite, Prometheus, Influx DB, ElasticSearch, MySQL, PostgreSQL, etc. You can now build dashboards in order to get the most from Vertica Prometheus metrics.</p><p>To help you get started, Vertica provides a set of dashboards in the new <a href=https://github.com/vertica/grafana-dashboards>grafana-dashboards</a> project. The project is open-source, and Vertica <a href=https://github.com/vertica/grafana-dashboards/blob/main/CONTRIBUTING.md>welcomes contributions</a>.</p><p>So far it consists of four dashboards(EON database only) that are public and available on <a href=https://grafana.com/grafana/dashboards/>Grafana</a>:</p><ul><li><a href=https://grafana.com/grafana/dashboards/19917-vertica-overview-prometheus/>Vertica Overview</a>: the overall state of your cluster.</li><li><a href=https://grafana.com/grafana/dashboards/19915-vertica-queries-prometheus/>Vertica Queries</a>: details about queries that are currently running in the cluster.</li><li><a href=https://grafana.com/grafana/dashboards/19914-vertica-depot-prometheus/>Vertica Depot</a>: details about depot usage.</li><li><a href=https://grafana.com/grafana/dashboards/19916-vertica-resource-management-prometheus/>Vertica Resource</a> Management: details about user-defined and built-in resource pool usage.</li></ul><p>You can find all Vertica Prometheus dashboards on <a href=https://grafana.com/grafana/dashboards/>Grafana</a> by typing vertica on the search bar:</p><p><img src=../../images/containers/grafana-search.png alt="Grafana dashboard"></p><h2 id=setting-up-prometheus-and-grafana>Setting up Prometheus and Grafana</h2><p>There are several ways to set up Prometheus and Grafana depending on the environment. It can be on a server (local or in the cloud) or a containerized environment like Docker and Kubernetes. For this tutorial, we are going to use Kubernetes as environment.</p><p>Prerequisites:</p><ul><li><a href=https://minikube.sigs.k8s.io/docs/>minikube Kubernetes (K8s) cluster</a>: if you do not have a cluster available, we install minikube before we begin.</li><li><a href=https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/>kubectl</a>: Kubernetes command-line tool. It is needed by Helm.</li><li><a href=https://helm.sh/>Helm</a>: package manager for Kubernetes.</li><li><a href=https://github.com/vertica/vertica-kubernetes>VerticaDB operator</a>: deploys Vertica on Kubernetes.</li></ul><h3 id=setting-up-k8s>Setting up K8s</h3><p>Let&rsquo;s set up a Kubernetes cluster and install some Kubernetes tools.</p><p>For this tutorial, we are going to use minikube. minikube is local Kubernetes, focusing on making it easy to learn and develop for Kubernetes.
Now let&rsquo;s install minikube. If you are running Linux, you can copy the commands below to your local machine. For other operating systems, refer to the minikube instructions to understand how to set that up.</p><pre tabindex=0><code>curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
sudo install minikube-linux-amd64 /usr/local/bin/minikube
</code></pre><p>With the program downloaded, you can create the Kubernetes cluster with the following command:</p><pre tabindex=0><code>minikube start
</code></pre><p>To easily install and manage some of our Kubernetes applications, we need Helm. Helm is a tool that automates the creation, packaging, configuration, and deployment of Kubernetes applications by combining your configuration files into a single reusable package.
Before installing Helm, you must have a local configured copy of kubectl:</p><pre tabindex=0><code>curl -LO &#34;https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl&#34;
sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
</code></pre><p>If Helm is not already installed, you can install it from a script:</p><pre tabindex=0><code>curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
chmod 700 get_helm.sh
./get_helm.sh
</code></pre><h3 id=installing-the-verticadb-operator>Installing the VerticaDB operator</h3><p>We are going to install the VerticaDB Operator through <a href=https://docs.vertica.com/latest/en/containerized/db-operator/installing-db-operator/#helm-charts>Helm charts</a>.</p><p>Add the Vertica Helm charts to your local repository, then update your local repository to ensure that it contains the latest available version of the Vertica Helm charts:</p><pre tabindex=0><code>helm repo add vertica-charts https://vertica.github.io/charts
helm repo update
</code></pre><p>Install the operator Helm chart:</p><pre tabindex=0><code>helm install --wait -n verticadb-operator --create-namespace vdb-op vertica-charts/verticadb-operator
</code></pre><h3 id=deploying-a-three-node-cluster>Deploying a three-node cluster</h3><p>To create an EON database, we need a location to store communal access data. For testing purposes, we will store the communal data in the minikube VM itself. By default, all host paths in minikube are owned by root. We will create a directory in one of these host paths and make it world readable so that Vertica can write to it.</p><pre tabindex=0><code>minikube ssh -- &#39;sudo mkdir -p /data/vertica &amp;&amp; sudo chmod a+w -R /data/vertica&#39;
</code></pre><p>With the operator deployed, we can now create a Vertica cluster. I will create a three-node cluster running with CE license.
Run this command to create a local manifest for the VerticaDB custom resource (CR):</p><pre tabindex=0><code>cat &lt;&lt; EOF &gt; vdb.yaml
apiVersion: vertica.com/v1
kind: VerticaDB
metadata:
  name: v
  annotations:
    vertica.com/include-uid-in-path: &#34;true&#34;
    vertica.com/run-nma-in-sidecar: &#34;false&#34;
    VERTICA_MEMDEBUG: &#34;2&#34;  # Required if running macOS with an arm based chip
spec:
  image: vertica/vertica-k8s:24.1.0-0-minimal
  communal:
    path: &#34;/communal&#34;
  subclusters:
  - name: sc1
    size: 3
  volumes:
  - name: server
    hostPath:
      path: /data/vertica
  volumeMounts:
  - name: server
    mountPath: /communal
EOF
</code></pre><p>Run this to create the above CR that will deploy Vertica:</p><pre tabindex=0><code>minikube kubectl -- apply -f vdb.yaml
</code></pre><p>Downloading the image and creating the database will take a few minutes. You can run this command to wait for the process to finish. Depending on your internet connection speed, you may need to repeat this command a few times.</p><pre tabindex=0><code>minikube kubectl -- wait vdb v --for=condition=DBInitialized=True --timeout=10m
</code></pre><h3 id=install-prometheus-and-grafana>Install Prometheus and Grafana</h3><p>We are going to use <a href=https://artifacthub.io/packages/helm/prometheus-community/kube-prometheus-stack>Kube Prometheus Stack</a>. It collects Kubernetes manifests, Grafana dashboards, and Prometheus rules combined with documentation and scripts to provide easy to operate end-to-end Kubernetes cluster monitoring with Prometheus using the Prometheus Operator.</p><pre tabindex=0><code>helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm repo update
helm install prometheus prometheus-community/kube-prometheus-stack --version 55.0.0
</code></pre><p>Afterwards we can list our pods and see if everything is running smoothly:</p><pre tabindex=0><code>kubectl get pods

alertmanager-prometheus-kube-prometheus-alertmanager-0   2/2     Running             0          115s
prometheus-grafana-7c68644486-8wf95                      3/3     Running             0          2m17s
prometheus-kube-prometheus-operator-7dccfb674d-4bb4z     1/1     Running             0          2m17s
prometheus-kube-state-metrics-6cd846d5cf-gwsb2           1/1     Running             0          2m17s
prometheus-prometheus-kube-prometheus-prometheus-0       2/2     Running             0          111s
prometheus-prometheus-node-exporter-m6k2b                1/1     Running             0          2m17s
</code></pre><p>You can access Prometheus UI. Run the following command to expose prometheus and access the dashboard on http://localhost:9090:</p><pre tabindex=0><code>kubectl port-forward svc/prometheus-operated 9090
</code></pre><p><img src=../../images/containers/expose-dashboard.png alt="Expose Grafana dashboard"></p><p>Prometheus is running but cannot connect to Vertica pods yet. To allow it to discover Vertica service, we are going to install a serviceMonitor.
Run this command to create a local manifest for the service monitor:</p><pre tabindex=0><code>cat &lt;&lt; EOF &gt; service-monitor.yaml
apiVersion: v1
kind: Secret
metadata:
  name: dbadmin
data:
  username: ZGJhZG1pbg==
  password: &#39;&#39;
type: Opaque
---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: vertica-server
  labels:
    release: prometheus
spec:
  endpoints:
    - basicAuth:
        password:
          key: password
          name: dbadmin
        username:
          key: username
          name: dbadmin
      interval: 1s
      path: /v1/metrics
      port: vertica-http
      scheme: https
      tlsConfig:
        insecureSkipVerify: true
  selector:
    matchLabels:
      app.kubernetes.io/name: vertica
EOF
</code></pre><p>Run this to create the above serviceMonitor:</p><pre tabindex=0><code>minikube kubectl -- apply -f service-monitor.yaml
</code></pre><p>Wait a little and refresh Prometheus on the browser. You will now be able to query the metrics:
<img src=../../images/containers/execute-queries.png alt="Query metrics screen"></p><p>You can access Grafana UI. Run the following command to expose Grafana and access the dashboard on <code>http://localhost:3000</code>:</p><pre tabindex=0><code>kubectl port-forward svc/prometheus-grafana 3000:80
</code></pre><p>Log in with the following credentials:</p><p>Username: <strong>admin</strong>
Password: <strong>prom-operator</strong>
<img src=../../images/containers/grafana-login.png alt="Grafana dashboard"></p><p>You would normally have to create a Prometheus data source in order for Grafana to connect to Prometheus but in this deployment, Grafana is pre-configured to connect to the Prometheus installed above.</p><p>Now, all that is left is to import the dashboards. First, we import <a href=https://grafana.com/grafana/dashboards/19917-vertica-overview-prometheus/>Vertica Overview</a>. Copy the dashboard ID and go to Grafana.</p><p>Paste the ID in <strong>Home</strong> > <strong>Dashboards</strong> > <strong>New</strong> > <strong>import</strong> > <strong>import via grafanana.com</strong>:</p><p><img src=../../images/containers/import-dashboard.png alt="Import dashboard"></p><p>Load the dashboard and click on <strong>Import</strong>. You will be able to view the dashboard:</p><p><img src=../../images/containers/view-dashboard.png alt="Grafana dashboard"></p><p>All the other dashboards can be imported the same way.</p><h2 id=tear-down-k8s-cluster>Tear down K8s cluster</h2><p>To clean up the minikube cluster after you are finished with it, run the following command:</p><pre tabindex=0><code>minikube delete
</code></pre></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2024 Open Text Corporation All Rights Reserved</small>
<small class=ml-1><a href=https://policies.google.com/privacy target=_blank rel=noopener>Privacy Policy</a></small></div></div></div></footer></div><script src=../../js/main.min.b6b5dd18889117d69a57d2b6ed518450be5b0d0206550559698a4233c65c109f.js integrity="sha256-trXdGIiRF9aaV9K27VGEUL5bDQIGVQVZaYpCM8ZcEJ8=" crossorigin=anonymous></script>
<script src=../../js/prism.js></script>
<script src=../../js/tabpane-persist.js></script></body></html>